package org.cardanofoundation.cip113.model.blueprint;

import com.bloxbean.cardano.client.crypto.Blake2bUtil;
import com.bloxbean.cardano.client.plutus.spec.BytesPlutusData;
import com.bloxbean.cardano.client.plutus.spec.ConstrPlutusData;
import com.bloxbean.cardano.client.plutus.spec.PlutusData;
import com.bloxbean.cardano.client.util.HexUtil;
import com.fasterxml.jackson.databind.ObjectMapper;
import lombok.extern.slf4j.Slf4j;
import org.junit.jupiter.api.Test;

@Slf4j
public class IssuancePolicyIdTest {

    private static final ObjectMapper OBJECT_MAPPER = new ObjectMapper();

    private static final String DUMMY_POLICY_ID = "deadbeefcafebabedeadbeefcafebabedeadbeefcafebabedeadbeef";

    private static final String DUMMY_ISSUANCE_POLICY = "590415010100332229800aba2aba1aba0aab9faab9eaab9dab9a488888896600264653001300800198041804800cdc3a400130080024888966002600460106ea800e2664464b30013005300b375400f132598009808800c4c8c96600260100031323259800980a801401a2c8090dd7180980098079baa0028acc004c01400626464b300130150028034590121bae3013001300f37540051640348068c034dd50009808000c5900e18061baa0078b2014132598009808000c4c8c96600266ebcc044c038dd500480a4566002646600200264660020026eacc04cc050c050c050c050c050c050c040dd5004112cc004006297ae08998099808180a00099801001180a800a0242259800800c528456600266ebcc04c00405a294626600400460280028071011456600260086530010019bab3012301330133013301330133013301330133013300f375400f480010011112cc00400a200319800801cc05400a64b3001300b30113754602200315980099baf301200100d899b800024800a2004808220048080c05000900320248acc004c010c8cc0040040108966002003148002266e012002330020023014001404515980099b8848000006264b30013375e6024601e6ea8c048c03cdd500080b44cdc39991192cc004c020c044dd5000c5200089bad3015301237540028080c966002601060226ea80062980103d87a8000899198008009bab30163013375400444b30010018a6103d87a8000899192cc004cdc8803000c56600266e3c018006266e9520003301830160024bd7045300103d87a80004051133004004301a00340506eb8c050004c05c005015202032330010010032259800800c5300103d87a8000899192cc004cdc8806000c56600266e3c030006266e9520003301730150024bd7045300103d87a8000404d1330040043019003404c6eb8c04c004c0580050141bab30123013300f37540026eb8c04800c00a294100d18089bac301130123012300e375400d15980099b880014800229462c806100c452820188a50403114a08062294100c1bad3010301100130103758601e003164034646600200264660020026eacc040c044c044c044c044c034dd5002912cc004006297ae08991991199119801001000912cc004006200713233016374e6602c6ea4014cc058c04c004cc058c0500052f5c0660060066030004602c00280a0dd598088019bae300e0013300300330130023011001403c44b30010018a5eb8226644b30013371e6eb8c04800801a2660226e9c008cc0100100062660080080028068dd618080009808800a01c375c601860126ea800cdc3a400516401c300800130033754011149a26cac8008980122d8799f581ce628b3210996aaf1d2a38ada3d250940b7caba6a94739dd9543812b7ff004c011e581cdeadbeefcafebabedeadbeefcafebabedeadbeefcafebabedeadbeef0001";

    private static final String ISSUANCE_DATUM = "d8799f5f5840590a8f010100332229800aba4aba2aba1aba0aab9faab9eaab9dab9cab9a4888888888cc896600264653001300b00198059806000cdc3a4001300b00248889665840002600460166ea800e264b3001005899192cc004c014c038dd5003c4c96600200300b8992cc0040062b300130150028992cc004c020006264b300100180744c958406600200300f807c03e01f13259800980c801c01e02080b0dd7000a0323016001405060246ea800a2b300130050018992cc00400601d13259800800c03e01f00f5840807c4c9660026032007007808202c375c00280c8c05800501418091baa002806a01e403c60206ea8006018809201900c80640310161809800a022300f375400f584000a403026644b300100180644c966002602a005133223233223298009800800cdd6980d180d8034dd7180d0032444a6603066e59240113746f6b656e735f666f5840725f706f6c6963793a20003732660066e9c02d22010015330183372c920104746e3a20003732660066ea400522010015330183372c9201057174793a200037325840660066ea0009220100159800acc004cdd7980e980d1baa0120218a518a9980c2493972656465656d65722e6d696e74696e675f6c6f6769635f63726564203d3d5840206d696e74696e675f6c6f6769635f63726564203f2046616c73650014a080ba2b3001598009919800800806912cc00400629422b30013375e603e00204714a358401330020023020001406480ea29462a66030921356c6973742e68617328696e766f6b65645f736372697074732c206d696e74696e675f6c6f6769635f63726564584029203f2046616c73650014a080ba2b3001598009806994c0040066eacc078c07cc07cc07cc07cc07cc07cc07cc07cc07cc06cdd5008520004004444b300100285840800c660020073021002992cc004c050c074dd5180e800c56600266ebcc07800405a266e00009200288012036880120363020002400c80f229462a6603092013d584073696e676c655f6d696e745f776974685f63726564656e7469616c2873656c662e72656465656d6572732c2072656465656d657229203f2046616c73650014a0584080ba2b30015980098069919800800806112cc0040062900044cdc02400466004004604000280ea29462a660309212b6c6973742e6c656e67746828746f6b656e5840735f666f725f706f6c69637929203d3d2031203f2046616c73650014a080ba2b30015980099b884800000a264b30010018a9980ca48128657870656374205b665840697273745f6f75747075742c202e2e5d203d2073656c662e6f757470757473001689929980d19b9649010e66697273745f6f75747075743a200037326600a0025840910100153301a3372c92011970726f6772616d6d61626c655f6c6f6769635f626173653a200037326600a048910100153301a3372c92012966697273745f6f755840747075742e616464726573732e7061796d656e745f63726564656e7469616c3a200037326600a603e60386ea8c07cc070dd5000a4500159800acc004cdd7980f5840980e1baa301f301c375400204914a3153301a4914a66697273745f6f75747075742e616464726573732e7061796d656e745f63726564656e7469616c203d3d20584070726f6772616d6d61626c655f6c6f6769635f62617365203f2046616c73650014a080ca2b30013370e6466446600400400244b3001001801c4c8cc8966002665840e4402400a2b30013371e0120051001803203e8998028029813002203e375c603e0026eb4c080004c0880050201919198008009bab30223023301f375400844b35840001001801c4c8cc896600266e4405c00a2b30013371e02e0051001803204089980280298138022040375c60400026eacc084004c08c0050210a5eb7bdb1805205840000048a518a9980d24813e7175616e746974795f6f662866697273745f6f75747075742e76616c75652c206f776e5f706f6c6963792c20746e29203d3d207174584079203f2046616c73650014a080ca2941019180f000a0383758603a603c603c60346ea803e2b30013371000490004528c54cc0612411743616e6e6f74206d696e584074207a65726f20746f6b656e730016405c80ba29462a660309211576616c69645f6d696e74696e67203f2046616c73650014a080ba29410174528202e8a504055840d14a080b844464b30010038991919911980500119b8a488101280059800800c4cdc52441035b5d2900006899b8a489035b5f20009800800ccdc52441025d29005840006914c00402a00530070014029229800805400a0028051009203e5980099b880014803a266e0120f2010018acc004cdc4000a41000513370066e012080140015840480362c80c90191bac301c002375a60340026466ec0dd4180d0009ba7301b001375400713259800800c4cdc52441027b7d00003899b8a489037b5f200032323358400010010032259800800c400e264b30010018994c00402a603e003337149101023a200098008054c08000600a805100a181100144ca6002015301f00199b8a4895840023a200098008054c080006600e66008008004805100a181100120403022001407c66e29220102207d0000340706eac00e264b3001001899b8a489025b5d000058403899b8a489035b5f20009800800ccdc52441015d00003914c00401e0053004001401d229800803c00a002803900620383758007133006375a00600513233714958401102682700329800800ccdc01b8d0024800666e292210127000044004444b3001337100049000440062646645300100699b800054800666e2ccdc00012cc004c5840dc40012402914818229037203c3371666e000056600266e2000520148a40c11481b901e002200c33706002901019b8600148080cdc70020012036375c00680f85840dc5245022c200022323300100100322598009807000c4cdc52450130000038acc004cdc4000a40011337149101012d0033002002337029000000c4cc014cdc20584000a402866e2ccdc019b85001480512060003405480a88888c8cc004004014896600200310058992cc004006266008603c00400d133005301e0023300300300145840070603c00280d8c004004c0540048896600266e2400920008800c6600200733708004900a4cdc599b803370a004900a240c0002801901140350121bac30130015840404464660020026eacc048c04cc04cc04cc04cc04cc04cc03cdd5002112cc004006297ae08998091807980980099801001180a000a02232330010013233001005840137566026602860286028602860206ea8014896600200314bd7044c8cc88cc88cc008008004896600200310038991980c9ba733019375200a66032602c002660584032602e00297ae033003003301b0023019001405c6eacc05000cdd7180880099801801980b001180a000a0242259800800c52f5c1133225980099b8f375c602a058400400d133014374e00466008008003133004004001403c6eb0c04c004c0500050111b874800a01100880440210121bae300f300c3754007164024300b001300635840754019149a2a660089211856616c696461746f722072657475726e65642066616c73650013656400c2a6600492012b657870656374205b285f63732c20746e2c584020717479295d203d20746f6b656e735f666f725f706f6c696379001615330024912172656465656d65723a20536d617274546f6b656e4d696e74696e674163745833696f6e0016260122d87a9f581c13eea981a402c3842e7a3d06018ddb27a89e4e102fc9a39f31800f33ff004c0122d87a9f581cff43ff0001ff";

    @Test
    public void testPrefixPostfix() {
        var parts = DUMMY_ISSUANCE_POLICY.split(DUMMY_POLICY_ID);
        log.info(parts[0]);
        log.info(parts[1]);
    }

    @Test
    public void testDerivedPolicyId() throws Exception {

//Log("hashed_param: h'C521D53D2F03EA3E4BA55C43A6ED0F9B3F1BF3D0EDBA21F7007D85B2'"),
//Log("postfix: h'FF0001'"),
//Log("computed_cs: h'C7AEEDAD7E9101431A1A46EE2D063A1B70A068AC7F66ACECD81C8C13'"),
//Log("cs_to_insert: h'A0C534520C02DBBD45D0CB6523210B3E72371CB1C05CB42FD58A85A2'"),

        var datum = PlutusData.deserialize(HexUtil.decodeHexString(ISSUANCE_DATUM));
        var json = OBJECT_MAPPER.readTree(OBJECT_MAPPER.writeValueAsString(datum));
        log.info("json: {}", json);

        var prefix = json.path("fields").get(0).path("bytes").asText();
        var postfix = json.path("fields").get(1).path("bytes").asText();

        log.info("prefix: {}", prefix);
        log.info("postfix: {}", postfix);

        var issuanceScriptHash = "a82718805c3541469346431c0cc023a76afce8d6d2c1c64d00bf1950";
        var bytes = BytesPlutusData.of(HexUtil.decodeHexString(issuanceScriptHash));
        log.info("bytes: {}", bytes.serializeToHex());

        var params = ConstrPlutusData.of(1, bytes);
        log.info("params: {}", params.serializeToHex());

        var newScript = prefix + params.serializeToHex() + postfix;

        var hash = Blake2bUtil.blake2bHash224(HexUtil.decodeHexString(newScript));

        log.info("hash: {}", HexUtil.encodeHexString(hash));


    }

}
